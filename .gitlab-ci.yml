stages:
  - build
  - test
  - deploy
  - update-manifest

variables:
  FRONT_ROOT: "service/front"
  FRONT_BUILD_OUTPUT: "dist"
  ECR_REPO_AUTH: "fromprom/auth"
  ECR_REPO_SEARCH: "fromprom/search"
  ECR_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

# ==========================================
# 1. Frontend Build
# ==========================================
build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - echo "üìÇ Moving to Frontend Directory..."
    - cd $FRONT_ROOT
    - echo "üèóÔ∏è Installing Dependencies & Building..."
    - npm ci
    - npm run build
  artifacts:
    paths:
      - "$FRONT_ROOT/$FRONT_BUILD_OUTPUT/"
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/front/**/*"

# ==========================================
# 2. Infrastructure Test
# ==========================================
test-infra-connection:
  stage: test
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - echo "üîç Checking AWS Connection..."
    - aws sts get-caller-identity
    - echo "üîç Checking EKS Connection..."
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl
    - aws eks update-kubeconfig --region $AWS_REGION --name fromprom-cluster
    - kubectl get nodes
  only:
    - main
    - gitlab-runner-backend-test

# ==========================================
# 3. Backend Build - Auth Service
# ==========================================
build-auth-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - echo "üèóÔ∏è Building Auth Service Docker Image..."
    - cd service/auth-service
    
    # Git ÏóêÎü¨ Î∞©ÏßÄÎ•º ÏúÑÌï¥ GitLab ÎÇ¥Ïû• Î≥ÄÏàò ÏÇ¨Ïö©
    - export IMAGE_TAG=$CI_COMMIT_SHORT_SHA
    - export IMAGE_NAME="$ECR_REGISTRY/$ECR_REPO_AUTH:$IMAGE_TAG"
    
    - echo "üì¶ Building image $IMAGE_NAME"
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $ECR_REGISTRY/$ECR_REPO_AUTH:latest
    
    - echo "üöÄ Pushing to ECR..."
    - docker push $IMAGE_NAME
    - docker push $ECR_REGISTRY/$ECR_REPO_AUTH:latest
    
    - echo $IMAGE_TAG > ../auth_image_tag.txt
  artifacts:
    paths:
      - service/auth_image_tag.txt
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/auth-service/**/*"

# ==========================================
# 4. Backend Build - Search Service
# ==========================================
build-search-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - echo "üèóÔ∏è Building Search Service Docker Image..."
    - cd service/search-service
    
    - export IMAGE_TAG=$CI_COMMIT_SHORT_SHA
    - export IMAGE_NAME="$ECR_REGISTRY/$ECR_REPO_SEARCH:$IMAGE_TAG"
    
    - echo "üì¶ Building image $IMAGE_NAME"
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $ECR_REGISTRY/$ECR_REPO_SEARCH:latest
    
    - echo "üöÄ Pushing to ECR..."
    - docker push $IMAGE_NAME
    - docker push $ECR_REGISTRY/$ECR_REPO_SEARCH:latest
    
    - echo $IMAGE_TAG > ../search_image_tag.txt
  artifacts:
    paths:
      - service/search_image_tag.txt
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/search-service/**/*"

# ==========================================
# 5. Frontend Deploy
# ==========================================
deploy-frontend:
  stage: deploy
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  needs: ["build-frontend"]
  script:
    - echo "üöÄ Deploying Frontend to S3..."
    - aws s3 sync $FRONT_ROOT/$FRONT_BUILD_OUTPUT/ s3://$S3_FRONT_BUCKET_NAME --delete
    - echo "üîÑ Invalidating CloudFront Cache..."
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/front/**/*"

# ==========================================
# 6. Update K8s Manifest & Secrets - Auth Service
# ==========================================
update-manifest-auth:
  stage: update-manifest
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  needs: ["build-auth-service"]
  before_script:
    - yum install -y git tar gzip
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl
    - aws eks update-kubeconfig --region $AWS_REGION --name fromprom-cluster
  script:
    - echo "üîê Syncing all GitLab Variables to K8s Secrets..."
    
    # 1. Î™®Îì† Î≥¥Ïïà Î≥ÄÏàòÎ•º ÌïòÎÇòÏùò SecretÏúºÎ°ú ÏÉùÏÑ±
    - |
      kubectl create secret generic auth-service-secrets \
        --from-literal=access-key="$AWS_ACCESS_KEY_ID" \
        --from-literal=secret-key="$AWS_SECRET_ACCESS_KEY" \
        --from-literal=cognito-client-id="$AWS_COGNITO_CLIENT_ID" \
        --from-literal=cognito-user-pool-id="$AWS_COGNITO_USER_POOL_ID" \
        --from-literal=sns-topic-arn="$AWS_SNS_TOPIC_ARN" \
        --dry-run=client -o yaml | kubectl apply -f -

    # 2. ÏùºÎ∞ò ÏÑ§Ï†ï Î≥ÄÏàòÎ•º ConfigMapÏúºÎ°ú ÏÉùÏÑ±
    - |
      kubectl create configmap auth-service-config \
        --from-literal=dynamodb-table-name="$AWS_DYNAMODB_TABLE_NAME" \
        --from-literal=aws-region="$AWS_REGION" \
        --dry-run=client -o yaml | kubectl apply -f -

    - echo "üìù Updating Manifest Image Tag..."
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
    - export IMAGE_TAG=$(cat service/auth_image_tag.txt)
    - git clone https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout ${CI_COMMIT_REF_NAME}
    - sed -i "s|image: ${ECR_REGISTRY}/${ECR_REPO_AUTH}:.*|image: ${ECR_REGISTRY}/${ECR_REPO_AUTH}:${IMAGE_TAG}|g" infra/k8s-manifests/auth-service.yaml
    - git add infra/k8s-manifests/auth-service.yaml
    - git commit -m "chore: update auth-service image to ${IMAGE_TAG} [skip ci]" || echo "No changes"
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/auth-service/**/*"

# ==========================================
# 7. Update K8s Manifest - Search Service 
# ==========================================
update-manifest-search:
  stage: update-manifest
  image: alpine:latest
  needs: ["build-search-service"]
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
    - git clone https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout ${CI_COMMIT_REF_NAME}
  script:
    - echo "üìù Updating Search Service Manifest..."
    - export IMAGE_TAG=$(cat ../service/search_image_tag.txt)
    - 'sed -i "s|image: ${ECR_REGISTRY}/${ECR_REPO_SEARCH}:.*|image: ${ECR_REGISTRY}/${ECR_REPO_SEARCH}:${IMAGE_TAG}|g" infra/k8s-manifests/search-service.yaml'
    - git add infra/k8s-manifests/search-service.yaml
    - 'git commit -m "chore: update search-service image to ${IMAGE_TAG} [skip ci]" || echo "No changes"'
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "service/search-service/**/*"