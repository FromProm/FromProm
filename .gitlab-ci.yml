stages:
  - test
  - sast
  - validate
  - deploy

variables:
  # EKS ì„¤ì •
  EKS_REGION: "ap-northeast-2"
  EKS_CLUSTER_NAME: "fromprom-cluster"
  
  # AgentCore ì„¤ì •
  AWS_REGION: "us-west-2"
  AGENTCORE_REGION: "us-west-2"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  
  # SonarQube ì„¤ì •
  SONAR_HOST_URL: "http://sonarqube-sonarqube.sonarqube.svc.cluster.local:9000"
  
  # Python ìµœì í™”
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

cache:
  paths:
    - .cache/pip/

# EKS ì—°ê²° í…ŒìŠ¤íŠ¸ (ì£¼ì„ ì²˜ë¦¬ - í•„ìš”ì‹œ í™œì„±í™”)
# runner-eks-test:
#   stage: test
#   image:
#     name: amazon/aws-cli:latest
#     entrypoint: [""]
#   before_script:
#     - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
#     - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
#     - aws eks update-kubeconfig --region $EKS_REGION --name $EKS_CLUSTER_NAME
#   script:
#     - kubectl get nodes
#     - kubectl get pods -A
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "dev"'

# SonarQube ë³´ì•ˆ ê²€ì‚¬
sonarqube:
  stage: sast
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  before_script:
    - cd service/ai-service
  script:
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.token=$SONAR_AI_TOKEN
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'

# ì½”ë“œ ê²€ì¦
validate:
  stage: validate
  image: python:3.11-slim
  before_script:
    - cd service/ai-service
    - pip install --no-cache-dir -e .
  script:
    - echo "ğŸ” Validating Python syntax..."
    - find app -name "*.py" -exec python3 -m py_compile {} +
    - echo "ğŸ“¦ Checking dependencies..."
    - pip check
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'

# AgentCore ë°°í¬
deploy-agentcore:
  stage: deploy
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git curl jq
    - pip install --no-cache-dir awscli bedrock-agentcore-starter-toolkit
    - echo "ğŸ” AWS ì¸ì¦ í™•ì¸..."
    - aws sts get-caller-identity || exit 1
    - cd service/ai-service
    - pip install --no-cache-dir -e .
  script:
    - echo "ğŸš€ AgentCore ë°°í¬ ì¤‘..."
    - agentcore deploy || exit 1
    - echo "âœ… AgentCore ë°°í¬ ì™„ë£Œ"
    - agentcore status
  artifacts:
    paths:
      - service/ai-service/.bedrock_agentcore.yaml
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
