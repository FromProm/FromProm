stages:
  - build
  - test
  - deploy
  - update-manifest

variables:
  FRONT_ROOT: "service/front"
  FRONT_BUILD_OUTPUT: "dist"
  AUTH_SERVICE_ROOT: "service/auth-service"
  SEARCH_SERVICE_ROOT: "service/search-service"
  ECR_REGISTRY: "261595668962.dkr.ecr.ap-northeast-2.amazonaws.com"
  ECR_REPO_AUTH: "fromprom/auth"
  ECR_REPO_SEARCH: "fromprom/search"
  AWS_DEFAULT_REGION: "ap-northeast-2"

# ==========================================
# 1. Frontend Build
# ==========================================
build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - echo "Moving to Frontend Directory..."
    - cd $FRONT_ROOT
    
    - echo "Installing Dependencies & Building..."
    - npm ci
    - npm run build
  artifacts:
    paths:
      - "$FRONT_ROOT/$FRONT_BUILD_OUTPUT/"
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$FRONT_ROOT/**/*"

# ==========================================
# 2. Infrastructure Test
# ==========================================
test-infra-connection:
  stage: test
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - echo "üîç Checking AWS Connection (IAM Role)..."
    # IAM RoleÏù¥ Ï†úÎåÄÎ°ú Ïó∞Í≤∞ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    - aws sts get-caller-identity
    
    - echo "üîç Checking EKS Connection..."
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl
    
    - aws eks update-kubeconfig --region $AWS_REGION --name fromprom-cluster
    - kubectl get nodes
  only:
    - main
    - gitlab-runner-backend-test

# ==========================================
# 3. Backend Build - Auth Service
# ==========================================
build-auth-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache aws-cli git
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - echo "üèóÔ∏è Building Auth Service Docker Image..."
    - cd $AUTH_SERVICE_ROOT
    
    # Generate image tag (commit short SHA)
    - export IMAGE_TAG=$(git rev-parse --short HEAD)
    - export IMAGE_NAME="$ECR_REGISTRY/$ECR_REPO_AUTH:$IMAGE_TAG"
    
    - echo "üì¶ Building image $IMAGE_NAME"
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $ECR_REGISTRY/$ECR_REPO_AUTH:latest
    
    - echo "üöÄ Pushing to ECR..."
    - docker push $IMAGE_NAME
    - docker push $ECR_REGISTRY/$ECR_REPO_AUTH:latest
    
    # Save image tag for manifest update
    - echo $IMAGE_TAG > ../image_tag.txt
  artifacts:
    paths:
      - service/image_tag.txt
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$AUTH_SERVICE_ROOT/**/*"

# ==========================================
# 4. Backend Build - Search Service
# ==========================================
build-search-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache aws-cli git
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - echo "üèóÔ∏è Building Search Service Docker Image..."
    - cd $SEARCH_SERVICE_ROOT
    
    # Generate image tag (commit short SHA)
    - export IMAGE_TAG=$(git rev-parse --short HEAD)
    - export IMAGE_NAME="$ECR_REGISTRY/$ECR_REPO_SEARCH:$IMAGE_TAG"
    
    - echo "üì¶ Building image $IMAGE_NAME"
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $ECR_REGISTRY/$ECR_REPO_SEARCH:latest
    
    - echo "üöÄ Pushing to ECR..."
    - docker push $IMAGE_NAME
    - docker push $ECR_REGISTRY/$ECR_REPO_SEARCH:latest
    
    # Save image tag for manifest update
    - echo $IMAGE_TAG > ../search_image_tag.txt
  artifacts:
    paths:
      - service/search_image_tag.txt
    expire_in: 1 hour
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$SEARCH_SERVICE_ROOT/**/*"

# ==========================================
# 5. Frontend Deploy
# ==========================================
deploy-frontend:
  stage: deploy
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  needs: ["build-frontend"]
  script:
    - echo "üöÄ Deploying Frontend to S3..."
    - aws s3 sync $FRONT_ROOT/$FRONT_BUILD_OUTPUT/ s3://$S3_FRONT_BUCKET_NAME --delete
    
    - echo "üîÑ Invalidating CloudFront Cache..."
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$FRONT_ROOT/**/*"

# ==========================================
# 6. Update K8s Manifest - Auth Service
# ==========================================
update-manifest-auth:
  stage: update-manifest
  image: alpine:latest
  needs: ["build-auth-service"]
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
  script:
    - echo "üìù Updating Auth Service Manifest..."
    
    # Read the image tag
    - export IMAGE_TAG=$(cat service/image_tag.txt)
    - 'echo "New image tag: $IMAGE_TAG"'
    
    # Update the manifest file
    - 'sed -i "s|image: ${ECR_REGISTRY}/${ECR_REPO_AUTH}:.*|image: ${ECR_REGISTRY}/${ECR_REPO_AUTH}:${IMAGE_TAG}|g" infra/k8s-manifests/auth-service.yaml'
    
    # Commit and push changes
    - git add infra/k8s-manifests/auth-service.yaml
    - 'git commit -m "chore: update auth-service image to ${IMAGE_TAG} [skip ci]" || echo "No changes to commit"'
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$AUTH_SERVICE_ROOT/**/*"

# ==========================================
# 7. Update K8s Manifest - Search Service
# ==========================================
update-manifest-search:
  stage: update-manifest
  image: alpine:latest
  needs: ["build-search-service"]
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
  script:
    - echo "üìù Updating Search Service Manifest..."
    
    # Read the image tag
    - export IMAGE_TAG=$(cat service/search_image_tag.txt)
    - 'echo "New image tag: $IMAGE_TAG"'
    
    # Update the manifest file
    - 'sed -i "s|image: ${ECR_REGISTRY}/${ECR_REPO_SEARCH}:.*|image: ${ECR_REGISTRY}/${ECR_REPO_SEARCH}:${IMAGE_TAG}|g" infra/k8s-manifests/search-service.yaml'
    
    # Commit and push changes
    - git add infra/k8s-manifests/search-service.yaml
    - 'git commit -m "chore: update search-service image to ${IMAGE_TAG} [skip ci]" || echo "No changes to commit"'
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  only:
    refs:
      - main
      - gitlab-runner-backend-test
    changes:
      - "$SEARCH_SERVICE_ROOT/**/*"