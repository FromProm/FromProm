stages:
  - test

variables:
  AWS_REGION: "ap-northeast-2"

runner-eks-test:
  stage: test
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    # 1. 변수 길이 및 상태 확인 (값 노출 방지)
    - echo "Checking AWS Credentials..."
    - if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "Error: AWS_ACCESS_KEY_ID is empty"; exit 1; fi
    - echo "Access Key ID length is ${#AWS_ACCESS_KEY_ID}" # 보통 20자
    - echo "Secret Access Key length is ${#AWS_SECRET_ACCESS_KEY}" # 보통 40자

    # 2. kubectl 설치
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl

    # 3. 자격 증명 명시적 주입 및 테스트
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - export AWS_DEFAULT_REGION=$AWS_REGION
    
    - aws eks update-kubeconfig --region $AWS_REGION --name fromprom-cluster
    - kubectl get nodes