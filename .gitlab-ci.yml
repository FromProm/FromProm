stages:
  - build
  - test
  - sast
  - deploy
  - update-manifest

variables:
  # Global Settings
  AWS_REGION: "ap-northeast-2"
  ECR_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
  EKS_CLUSTER_NAME: "fromprom-cluster"
  
  

  # Python Optimization
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONDONTWRITEBYTECODE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  
  # Gradle Optimization
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Ï†ÑÏó≠ Ï∫êÏãú ÏÑ§Ï†ï (Í∞Å JobÏóêÏÑú override Í∞ÄÎä•)
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cache/pip/
    - .gradle/
    - service/front/node_modules/

# ==========================================
# [Template] Backend Build (Docker)
# ==========================================
.build_backend_template:
  stage: build
  image: docker:24-cli
  variables:
    DOCKER_HOST: "tcp://docker:2376"
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: "1"
    DOCKER_CERT_PATH: "/certs/client"
  cache: {} # Ï†ÑÏó≠ Ï∫êÏãú ÎπÑÌôúÏÑ±Ìôî
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - echo "üèóÔ∏è Building $SERVICE_NAME Docker Image..."
    - cd service/$SERVICE_DIR
    - export IMAGE_TAG=$CI_COMMIT_SHORT_SHA
    - export IMAGE_NAME="$ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG"
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $ECR_REGISTRY/$ECR_REPO:latest
    - echo "üöÄ Pushing to ECR..."
    - docker push $IMAGE_NAME
    - docker push $ECR_REGISTRY/$ECR_REPO:latest
    - echo $IMAGE_TAG > ../${SERVICE_NAME}_image_tag.txt
  artifacts:
    paths:
      - service/${SERVICE_NAME}_image_tag.txt
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/$SERVICE_DIR/**/*"

# ==========================================
# [Template] Update Manifest
# ==========================================
.update_manifest_template:
  stage: update-manifest
  image: bitnami/git:latest # GitÏù¥ ÏµúÏ†ÅÌôîÎêú Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
  needs: [] # Í∞Å JobÏóêÏÑú Ïò§Î≤ÑÎùºÏù¥Îìú
  before_script:
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
  script:
    - echo "üìù Updating $SERVICE_NAME Manifest..."
    - export IMAGE_TAG=$(cat service/${SERVICE_NAME}_image_tag.txt)
    - git clone https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout ${CI_COMMIT_REF_NAME}
    # Race Condition Î∞©ÏßÄ: Rebase ÏãúÎèÑ
    - git pull --rebase origin ${CI_COMMIT_REF_NAME}
    - 'sed -i "s|image: ${ECR_REGISTRY}/${ECR_REPO}:.*|image: ${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}|g" infra/k8s-manifests/${MANIFEST_FILE}'
    - git add infra/k8s-manifests/${MANIFEST_FILE}
    - 'git commit -m "chore: update $SERVICE_NAME image to ${IMAGE_TAG} [skip ci]" || echo "No changes"'
    # Push Ïã§Ìå® Ïãú Ïû¨ÏãúÎèÑ Î°úÏßÅ (Í∞ÑÎã®Ìïú ÌòïÌÉú)
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/$SERVICE_DIR/**/*"

# ==========================================
# 1. Frontend Build
# ==========================================
build-frontend:
  stage: build
  image: node:20-alpine
  variables:
    FRONT_ROOT: "service/front"
    FRONT_BUILD_OUTPUT: "dist"
  script:
    - cd $FRONT_ROOT
    - npm ci --prefer-offline --no-audit
    - npm run build
  artifacts:
    paths:
      - "$FRONT_ROOT/$FRONT_BUILD_OUTPUT/"
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/front/**/*"

# ==========================================
# 2-4. Backend Builds (Using Template)
# ==========================================
build-auth-service:
  extends: .build_backend_template
  variables:
    SERVICE_NAME: "auth"
    SERVICE_DIR: "auth-service"
    ECR_REPO: "fromprom/auth"

build-search-service:
  extends: .build_backend_template
  variables:
    SERVICE_NAME: "search"
    SERVICE_DIR: "search-service"
    ECR_REPO: "fromprom/search"

build-ai-service:
  extends: .build_backend_template
  variables:
    SERVICE_NAME: "ai"
    SERVICE_DIR: "ai-service"
    ECR_REPO: "fromprom/ai"

# ==========================================
# 5. Infrastructure Test
# ==========================================
test-infra-connection:
  stage: test
  image: amazon/aws-cli:latest
  script:
    - echo "üîç Checking Connections..."
    - aws sts get-caller-identity
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl" && chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
    - kubectl get nodes
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'

# ==========================================
# 6-8. SonarQube (SAST) - ÏÑúÎπÑÏä§Î≥Ñ Î∂ÑÎ¶¨
# ==========================================
sonarqube-ai:
  stage: sast
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "sonar-ai-${CI_COMMIT_REF_SLUG}"
    paths:
      - .sonar/cache
  script:
    - cd service/ai-service
    - sonar-scanner -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "feature/sonartest"'
      changes:
        - "service/ai-service/**/*"

sonarqube-auth:
  stage: sast
  image: gradle:8.5-jdk17
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "sonar-auth-${CI_COMMIT_REF_SLUG}"
    paths:
      - .sonar/cache
      - service/auth-service/.gradle/
  before_script:
    # sonar-scanner ÏÑ§Ïπò
    - apt-get update && apt-get install -y unzip curl
    - curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
    - unzip -q sonar-scanner.zip
    - export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"
  script:
    - cd service/auth-service
    - chmod +x gradlew
    - ./gradlew build -x test
    - sonar-scanner -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "feature/sonartest"'
      changes:
        - "service/auth-service/**/*"

sonarqube-search:
  stage: sast
  image: gradle:8.5-jdk17
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "sonar-search-${CI_COMMIT_REF_SLUG}"
    paths:
      - .sonar/cache
      - service/search-service/.gradle/
  before_script:
    # sonar-scanner ÏÑ§Ïπò
    - apt-get update && apt-get install -y unzip curl
    - curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
    - unzip -q sonar-scanner.zip
    - export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"
  script:
    - cd service/search-service
    - chmod +x gradlew
    - ./gradlew build -x test
    - sonar-scanner -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "feature/sonartest"'
      changes:
        - "service/search-service/**/*"

# ==========================================
# 9. Frontend Deploy
# ==========================================
deploy-frontend:
  stage: deploy
  image: amazon/aws-cli:latest
  needs: ["build-frontend"]
  variables:
    FRONT_ROOT: "service/front"
    FRONT_BUILD_OUTPUT: "dist"
  script:
    - aws s3 sync $FRONT_ROOT/$FRONT_BUILD_OUTPUT/ s3://$S3_FRONT_BUCKET_NAME --delete
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/front/**/*"

# ==========================================
# 10. AI Service Deploy (Manual)
# ==========================================
deploy-ai-agentcore:
  stage: deploy
  image: python:3.11-slim
  variables:
    AWS_REGION: "us-west-2"
  script:
    - apt-get update && apt-get install -y --no-install-recommends git curl jq
    - pip install --no-cache-dir awscli bedrock-agentcore-starter-toolkit
    - cd service/ai-service
    - pip install --no-cache-dir -e .
    - agentcore deploy || exit 1
    - agentcore status
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/ai-service/**/*"
  when: manual

# ==========================================
# 11-13. Update Manifests (Using Template)
# ==========================================
update-manifest-auth:
  # extendsÎ•º Ïì∞Îêò, Secret ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ ÎïåÎ¨∏Ïóê scriptÎ•º override ÌïòÍ±∞ÎÇò before_scriptÏóê Ï∂îÍ∞Ä
  stage: update-manifest
  image: amazon/aws-cli:latest # kubectl ÏÑ§Ïπò ÌïÑÏöîÎ°ú Ïù∏Ìï¥ aws-cli Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
  needs: ["build-auth-service"]
  before_script:
    - yum install -y git
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl" && chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
  script:
    - echo "üîê Syncing Secrets..."
    # Secret/ConfigMap ÏÉùÏÑ± Î°úÏßÅ (Dry-run Ï†ÅÏö©Îê®)
    - |
      kubectl create secret generic auth-service-secrets \
        --from-literal=access-key="$AWS_ACCESS_KEY_ID" \
        --from-literal=secret-key="$AWS_SECRET_ACCESS_KEY" \
        --from-literal=cognito-client-id="$AWS_COGNITO_CLIENT_ID" \
        --from-literal=cognito-user-pool-id="$AWS_COGNITO_USER_POOL_ID" \
        --from-literal=sns-topic-arn="$AWS_SNS_TOPIC_ARN" \
        --dry-run=client -o yaml | kubectl apply -f -
    - |
      kubectl create configmap auth-service-config \
        --from-literal=dynamodb-table-name="$AWS_DYNAMODB_TABLE_NAME" \
        --from-literal=aws-region="$AWS_REGION" \
        --dry-run=client -o yaml | kubectl apply -f -
    # Manifest ÏóÖÎç∞Ïù¥Ìä∏ (ÌÖúÌîåÎ¶ø Î°úÏßÅ ÏßÅÏ†ë Íµ¨ÌòÑ - extends script override Î∞©ÏßÄ)
    - echo "üìù Updating Manifest..."
    - export IMAGE_TAG=$(cat service/auth_image_tag.txt)
    - git clone https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout ${CI_COMMIT_REF_NAME}
    - git pull --rebase origin ${CI_COMMIT_REF_NAME}
    - 'sed -i "s|image: ${ECR_REGISTRY}/fromprom/auth:.*|image: ${ECR_REGISTRY}/fromprom/auth:${IMAGE_TAG}|g" infra/k8s-manifests/auth-service.yaml'
    - git add infra/k8s-manifests/auth-service.yaml
    - 'git commit -m "chore: update auth image to ${IMAGE_TAG} [skip ci]" || echo "No changes"'
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/auth-service/**/*"

update-manifest-search:
  stage: update-manifest
  image: amazon/aws-cli:latest
  needs: ["build-search-service"]
  before_script:
    - yum install -y git
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl" && chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
    - git config --global user.email "gitlab-ci@fromprom.cloud"
    - git config --global user.name "GitLab CI"
  script:
    - echo "üîê Syncing Secrets..."
    # Secret ÏÉùÏÑ± (OpenSearch Ïù∏Ï¶ù Ï†ïÎ≥¥)
    - |
      kubectl create secret generic search-service-secrets \
        --from-literal=opensearch-username="$OPENSEARCH_USERNAME" \
        --from-literal=opensearch-password="$OPENSEARCH_PASSWORD" \
        --dry-run=client -o yaml | kubectl apply -f -
    # ConfigMap ÏóÖÎç∞Ïù¥Ìä∏ (OpenSearch Ìò∏Ïä§Ìä∏)
    - |
      kubectl create configmap search-service-config \
        --from-literal=aws-region="$AWS_REGION" \
        --from-literal=dynamodb-table-name="$AWS_DYNAMODB_TABLE_NAME" \
        --from-literal=opensearch-host="$OPENSEARCH_HOST" \
        --from-literal=opensearch-port="443" \
        --from-literal=opensearch-protocol="https" \
        --dry-run=client -o yaml | kubectl apply -f -
    # Manifest ÏóÖÎç∞Ïù¥Ìä∏
    - echo "üìù Updating Manifest..."
    - export IMAGE_TAG=$(cat service/search_image_tag.txt)
    - git clone https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout ${CI_COMMIT_REF_NAME}
    - git pull --rebase origin ${CI_COMMIT_REF_NAME}
    - 'sed -i "s|image: ${ECR_REGISTRY}/fromprom/search:.*|image: ${ECR_REGISTRY}/fromprom/search:${IMAGE_TAG}|g" infra/k8s-manifests/search-service.yaml'
    - git add infra/k8s-manifests/search-service.yaml
    - 'git commit -m "chore: update search image to ${IMAGE_TAG} [skip ci]" || echo "No changes"'
    - git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      changes:
        - "service/search-service/**/*"

update-manifest-ai:
  extends: .update_manifest_template
  needs: ["build-ai-service"]
  variables:
    SERVICE_NAME: "ai"
    SERVICE_DIR: "ai-service"
    ECR_REPO: "fromprom/ai"
    MANIFEST_FILE: "ai-service.yaml"