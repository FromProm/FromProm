stages:
  - build
  - test
  - deploy

variables:
  FRONT_ROOT: "service/front"
  # ë¹Œë“œ ê²°ê³¼ë¬¼ í´ë”ëª…
  FRONT_BUILD_OUTPUT: "dist"

# ==========================================
# 1. Frontend Build
# ==========================================
build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - echo "ğŸ“‚ Moving to Frontend Directory: $FRONT_ROOT"
    - cd $FRONT_ROOT
    
    - echo "ğŸ—ï¸ Installing Dependencies & Building..."
    - npm ci
    - npm run build
  artifacts:
    paths:
      - "$FRONT_ROOT/$FRONT_BUILD_OUTPUT/"
    expire_in: 1 hour
  only:
    refs:
      - main
      - GitLab-Runner-Test 
    changes:
      - "$FRONT_ROOT/**/*"

# ==========================================
# 2. Infrastructure Test
# ==========================================
test-infra-connection:
  stage: test
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  script:
    - echo "ğŸ” Checking AWS Connection (IAM Role)..."
    # IAM Roleì´ ì œëŒ€ë¡œ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸
    - aws sts get-caller-identity
    
    - echo "ğŸ” Checking EKS Connection..."
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl
    
    - aws eks update-kubeconfig --region $AWS_REGION --name fromprom-cluster
    - kubectl get nodes
  only:
    - main
    - GitLab-Runner-Test

# ==========================================
# 3. Frontend Deploy
# ==========================================
deploy-frontend:
  stage: deploy
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  needs: ["build-frontend"]
  script:
    - echo "ğŸš€ Deploying Frontend to S3..."
    - aws s3 sync $FRONT_ROOT/$BUILD_OUTPUT/ s3://$S3_FRONT_BUCKET_NAME --delete
    
    - echo "ğŸ”„ Invalidating CloudFront Cache..."
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
  only:
    refs:
      - main
      - GitLab-Runner-Test
    changes:
      - "$FRONT_ROOT/**/*"
    # CLOUDFRONT_DIST_ID ë³€ìˆ˜ëŠ” GitLab Settingsì—ì„œ ê°€ì ¸ì˜´
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DIST_ID --paths "/*"
  only:
    refs:
      - main
      - GitLab-Runner-Test
    changes:
      - "$FRONT_ROOT/**/*"